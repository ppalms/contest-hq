<%= turbo_frame_tag "music_selections" do %>
  <div class="pt-8 gap-4">
    <div class="flex justify-between items-center mb-4">
      <h2>Edit Music Selections</h2>
    </div>

    <% if @has_conflicts %>
      <div class="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
            </svg>
          </div>
          <div class="ml-3">
            <p class="text-sm font-medium"><%= @conflict_message %></p>
          </div>
        </div>
      </div>
    <% end %>

    <%= form_with url: bulk_update_contest_entry_selections_path(entry_id: @contest_entry.id),
                  method: :patch,
                  data: { 
                    controller: "music-bulk-edit unsaved-changes",
                    unsaved_changes_target: "form"
                  } do |f| %>

      <div class="space-y-4" data-music-bulk-edit-target="list">
        <% @slots.each do |slot| %>
          <% if slot[:type] == :prescribed %>
            <%# Prescribed Slot - Uses Turbo Frame for inline replacement %>
            <%= render "music_selections/prescribed_slot", slot: slot, contest_entry: @contest_entry %>
          <% elsif slot[:music_selection].present? %>
            <%# Filled Custom Slot %>
            <div class="p-4 bg-white rounded-lg border border-gray-300 <%= 'opacity-60 bg-gray-100' if slot[:is_deleted] %> <%= 'bg-green-50 border-green-300' if slot[:is_new] %>"
                 data-music-bulk-edit-target="item"
                 data-slot-position="<%= slot[:position] %>"
                 data-prescribed="false">

              <div class="flex items-center gap-4">
                <%# Up/Down Arrows %>
                <div class="flex flex-col gap-1">
                  <button type="button"
                          class="p-1 text-gray-500 hover:text-gray-700 disabled:opacity-30"
                          data-action="music-bulk-edit#moveUp">
                    ▲
                  </button>
                  <button type="button"
                          class="p-1 text-gray-500 hover:text-gray-700 disabled:opacity-30"
                          data-action="music-bulk-edit#moveDown"
                          <%= 'disabled' if slot[:position] == 3 %>>
                    ▼
                  </button>
                </div>

                <%# Hidden Fields %>
                <%= hidden_field_tag "music_selections[][id]", slot[:music_selection].id %>
                <%= hidden_field_tag "music_selections[][position]", slot[:position],
                                     data: { music_bulk_edit_target: "position" } %>
                <%= hidden_field_tag "music_selections[][_destroy]", "0",
                                     data: { music_bulk_edit_target: "deleteField" } %>

                <%# Title/Composer Fields %>
                <div class="flex-1 grid grid-cols-2 gap-4">
                  <div>
                    <%= label_tag "music_selections[][title]", "Title", class: "block text-sm font-medium text-gray-700 mb-1" %>
                    <%= text_field_tag "music_selections[][title]", slot[:music_selection].title,
                                       class: "text-field w-full",
                                       data: { music_bulk_edit_target: "titleField" } %>
                  </div>
                  <div>
                    <%= label_tag "music_selections[][composer]", "Composer", class: "block text-sm font-medium text-gray-700 mb-1" %>
                    <%= text_field_tag "music_selections[][composer]", slot[:music_selection].composer,
                                       class: "text-field w-full",
                                       data: { music_bulk_edit_target: "composerField" } %>
                  </div>
                </div>

                <%# Badges and Actions %>
                <div class="flex items-center gap-2">
                  <% if slot[:is_new] %>
                    <span class="px-2 py-1 text-xs font-medium text-green-800 bg-green-100 rounded status-badge">
                      New
                    </span>
                  <% end %>
                  <button type="button"
                          data-action="music-bulk-edit#markDeleted"
                          class="btn-danger-sm delete-btn">
                    Delete
                  </button>
                  <button type="button"
                          data-action="music-bulk-edit#undoDelete"
                          class="btn-secondary-sm undo-btn hidden">
                    Undo
                  </button>
                </div>
              </div>
            </div>

          <% else %>
            <%# Empty Custom Slot %>
            <div class="rounded-lg border-2 border-dashed border-gray-300"
                 data-slot
                 data-slot-type="custom"
                 data-slot-position="<%= slot[:position] %>">

              <%# Placeholder (shown by default) %>
              <div class="placeholder p-6 text-center">
                <p class="text-gray-500 mb-3">Empty slot</p>
                <button type="button"
                        data-action="music-bulk-edit#showAddForm"
                        class="btn-primary-sm">
                  Add
                </button>
              </div>

              <%# Add Form (hidden by default) %>
              <div class="add-form hidden">
                <%= render "music_selections/inline_add_form",
                           slot: slot,
                           contest_entry: @contest_entry %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>

      <%# Hidden field to track deletions %>
      <div data-music-bulk-edit-target="deletions"></div>

      <div class="flex justify-end gap-2 mt-6">
        <%= link_to "Cancel",
                    contest_entry_path(@contest_entry.contest, @contest_entry),
                    class: "btn-secondary",
                    data: { 
                      turbo_frame: "_top",
                      action: "click->unsaved-changes#allowNavigation"
                    } %>
        <%= f.submit "Save", 
                     class: "btn-primary",
                     data: { action: "click->unsaved-changes#allowNavigation" } %>
      </div>
    <% end %>
  </div>
<% end %>
